{% extends "/base.html" %}

{% block content %}

{% if multiple %}
    <div id="record_box" class="clearfix">
        <p>There appear to be multiple records with this ID:</p>
        <ul>
        {% for item in io.set() %}
            <li>{{item['citekey']}} - 
                <a href="/record/{{item['id']}}">{{item['id']}}</a>
            </li>
        {% endfor %}
        </ul>
    </div>
{% elif edit %}
    <div class="row">
    <a href="" id="savethis" class="btn span3">save changes</a>
    <a href="" id="deletethis" class="btn danger span3">delete record</a>
    <a href="" id="savenew" class="btn span3">save as new record</a>
    </div>
    <div class="row">
    <div id="therecord" class="record_box span8">
    {% if io.set()[0]['type'] == "assembly" %}
        <h3>Assembly {{io.set()[0]['id']}} - {{io.set()[0]['name']}}</h3>
    {% else %}
        <h3>Part {{io.set()[0]['id']}}</h3>
    {% endif %}
    <script type="text/javascript">
    jQuery(document).ready(function() {
        jQuery('#therecord').jtedit({"source":window.location.pathname+".json","noedit":["id"]});

        var saveit = function(event) {
            event.preventDefault();
            var thedata = $.parseJSON(jQuery('#jtedit_json').val());
            if (jQuery(this).attr('id') == "savethis" ) {
                var saveurl = '/record/{{io.set()[0]['id']}}?version={{io.get_record_version(io.set()[0]['id'])}}';
            } else {
                var saveurl = '/record/create';
            }
            $.ajax({
                url: saveurl
                , type: 'POST'
                , data: JSON.stringify(thedata)
                , contentType: "application/json; charset=utf-8" 
                , dataType: 'json'
                , processData: false
                , success: function(data, statusText, xhr) {
                    if (data.action == "new") {
                        alert("New record saved. Redirecting to new record page.");
                        window.location = '/record/' + data.id;
                    } else {
                        alert("Record updated. Refreshing page.");
                    }
                    window.location = '/record/' + data.id;
                }
                , error: function(xhr, message, error) {
                    alert("failed! " + error);
                }
            });
            var children = jQuery('#newchildren').val().split(',')
            for (var child in children) {
                children[child].replace(' ','')
                if (children[child].length > 0) {
                    savechildren(children[child],'{{io.set()[0]['id']}}')
                }
            }
        }

        var savechildren = function(child,parentid) {
            $.ajax({
                url: '/record/' + child + '.json'
                , type: 'GET'
                , success: function(data, statusText, xhr) {
                    var oldparent = data['assembly']
                    data.assembly = parentid
                    if (data.hasOwnProperty('assembly_history')) {
                        if (typeof(data['assembly_history']) == 'object') {
                            data['assembly_history'].append(oldparent)
                        } else {
                            data['assembly_history'] = [data['assembly_history'],oldparent]
                        }
                    } else {
                        data['assembly_history'] = [oldparent]
                    }
                    $.ajax({
                        url: '/record/' + child
                        , type: 'POST'
                        , data: JSON.stringify(data)
                        , contentType: "application/json; charset=utf-8" 
                        , dataType: 'json'
                        , processData: false
                        , success: function(data, statusText, xhr) {
                            alert("parts added.");
                        }
                        , error: function(xhr, message, error) {
                            alert("failed! " + error);
                        }
                    })
                }
                , error: function(xhr, message, error) {
                    alert("failed! " + error);
                }
            })
        }

        var deleteit = function(event) {
            event.preventDefault();
            $.ajax({
                url: '/record/{{io.set()[0]['id']}}?delete=true'
                , type: 'POST'
                , success: function(data, statusText, xhr) {
                    alert("Record deleted. Redirecting to homepage.");
                    window.location = '/';
                }
                , error: function(xhr, message, error) {
                    alert("failed! " + error);
                }
            });            
        }
        
        jQuery('#savethis').bind('click',saveit);
        jQuery('#savenew').bind('click',saveit);
        jQuery('#deletethis').bind('click',deleteit);
    });
    </script>
    </div>
    {% if io.set()[0]['type'] == "assembly" %}
        <div class="record_box span5">
        {% if io.get_children() %}
            <h3>Contains parts</h3>
            <ul>
            {% for item in io.get_children() %}
                <li><a href="/record/{{item['id']}}">{{item['id']}}</a> - {{item['name']}}</li>
            {% endfor %}
            </ul>
        {% else %}
            <h3>No parts listed in this assembly</h3>
        {% endif %}
        <p>Add parts:</p>
        <textarea id="newchildren"></textarea>
        <p>(enter the IDs of parts you want to add to this assembly, separated by commas. 
        If you do not know the ID, <a target="_blank" href="/search">try searching</a> based on other information about the part.)</p>
        </div>
    {% endif %}

    </div>

{% else %}
    <div class="row">
    {{io.get_record_as_table()|safe}}
    </div>
{% endif %}

{% endblock %}

